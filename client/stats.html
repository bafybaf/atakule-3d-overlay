<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atakule 3D Video ƒ∞statistikleri</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #0b0b0b;
            color: #ddd;
            font-family: 'Poppins', system-ui, Segoe UI, Roboto, Arial;
            min-height: 100vh;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 32px;
            font-weight: bold;
        }
        
        .header p {
            margin: 0;
            opacity: 0.9;
            font-size: 16px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            color: white;
        }
        
        .stat-card.videos {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }
        
        .stat-card.downloads {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }
        
        .stat-card.ips {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
        }
        
        .stat-card.names {
            background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
        }
        
        .content-card {
            background: #1a1a1a;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #333;
        }
        
        .content-card h3 {
            margin: 0 0 20px 0;
            font-size: 20px;
        }
        
        .content-card h3.videos {
            color: #4CAF50;
        }
        
        .content-card h3.activity {
            color: #2196F3;
        }
        
        .content-card h3.hourly {
            color: #FF9800;
        }
        
        .content-card h3.daily {
            color: #9C27B0;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top: 4px solid #4CAF50;
            border-right: 4px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .error {
            text-align: center;
            color: #f44336;
            padding: 20px;
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 20px;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
        }
        
        .activity-item {
            padding: 12px;
            background: #2a2a2a;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #2196F3;
        }
        
        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .activity-name {
            font-weight: 500;
        }
        
        .activity-time {
            color: #888;
            font-size: 12px;
        }
        
        .activity-details {
            color: #888;
            font-size: 14px;
        }
        
        .name-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #2a2a2a;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        .name-rank {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: #000;
            margin-right: 12px;
        }
        
        .name-rank.top3 {
            background: #FFD700;
        }
        
        .name-rank.other {
            background: #4CAF50;
        }
        
        .name-info {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .name-count {
            color: #888;
            font-size: 14px;
        }
        
        .chart-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #2a2a2a;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .chart-label {
            font-size: 14px;
        }
        
        .chart-visual {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chart-bar-bg {
            width: 60px;
            height: 4px;
            background: #333;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .chart-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .chart-bar-fill.hourly {
            background: #FF9800;
        }
        
        .chart-bar-fill.daily {
            background: #9C27B0;
        }
        
        .chart-count {
            font-size: 12px;
            color: #888;
            min-width: 20px;
        }
    </style>
</head>
<body>
    <button class="back-button" onclick="window.location.href='/'">
        üè† Ana Sayfa
    </button>
    
    <div class="container">
        <div class="header">
            <h1>üìä Atakule 3D Video ƒ∞statistikleri</h1>
            <p>Ger√ßek zamanlƒ± kullanƒ±m verileri</p>
        </div>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
        </div>
        
        <div id="error" class="error" style="display: none;">
            <h2>‚ùå Hata</h2>
            <p id="error-message"></p>
            <button class="refresh-btn" onclick="loadStats()">Tekrar Dene</button>
        </div>
        
        <div id="content" style="display: none;">
            <!-- Ana ƒ∞statistikler -->
            <div class="stats-grid">
                <div class="stat-card videos">
                    <div class="stat-number" id="total-videos">0</div>
                    <div class="stat-label">üé¨ Toplam Video</div>
                </div>
                
                <div class="stat-card downloads">
                    <div class="stat-number" id="total-downloads">0</div>
                    <div class="stat-label">üì• Toplam ƒ∞ndirme</div>
                </div>
                
                <div class="stat-card ips">
                    <div class="stat-number" id="unique-ips">0</div>
                    <div class="stat-label">üåê Benzersiz IP</div>
                </div>
                
                <div class="stat-card names">
                    <div class="stat-number" id="unique-names">0</div>
                    <div class="stat-label">üë§ Farklƒ± ƒ∞sim</div>
                </div>
            </div>
            
            <!-- ƒ∞√ßerik Grid -->
            <div class="content-grid">
                <!-- En Pop√ºler ƒ∞simler -->
                <div class="content-card">
                    <h3 class="videos">üèÜ En Pop√ºler ƒ∞simler</h3>
                    <div id="top-names">
                        <div style="color: #888; text-align: center; padding: 20px;">
                            Hen√ºz veri yok
                        </div>
                    </div>
                </div>
                
                <!-- Son Aktiviteler -->
                <div class="content-card">
                    <h3 class="activity">‚è∞ Son Aktiviteler</h3>
                    <div id="recent-activity">
                        <div style="color: #888; text-align: center; padding: 20px;">
                            Hen√ºz aktivite yok
                        </div>
                    </div>
                </div>
                
                <!-- Saatlik ƒ∞statistikler -->
                <div class="content-card">
                    <h3 class="hourly">üìà Son 24 Saat</h3>
                    <div id="hourly-stats">
                        <div style="color: #888; text-align: center; padding: 20px;">
                            Hen√ºz veri yok
                        </div>
                    </div>
                </div>
                
                <!-- G√ºnl√ºk ƒ∞statistikler -->
                <div class="content-card">
                    <h3 class="daily">üìÖ Son 7 G√ºn</h3>
                    <div id="daily-stats">
                        <div style="color: #888; text-align: center; padding: 20px;">
                            Hen√ºz veri yok
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div style="text-align: center; margin-top: 40px; padding: 20px; color: #888; font-size: 14px;">
                <p>Son g√ºncelleme: <span id="last-update"></span></p>
                <button class="refresh-btn" onclick="loadStats()">üîÑ Yenile</button>
            </div>
        </div>
    </div>
    
    <script>
        // Alan adƒ±na g√∂re dinamik API URL olu≈ütur
        function getApiUrl() {
            const hostname = window.location.hostname;
            const protocol = window.location.protocol;
            const port = window.location.port;
            
            // Localhost i√ßin
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return `${protocol}//${hostname}:3000`;
            }
            
            // Production domain i√ßin
            return `${protocol}//${hostname}${port ? ':' + port : ''}`;
        }
        
        // Locale baƒüƒ±msƒ±z tarih formatƒ±
        function formatDateLocale(dateString) {
            const date = new Date(dateString);
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            return new Intl.DateTimeFormat('en-US', options).format(date);
        }
        
        // Locale baƒüƒ±msƒ±z sayƒ± formatƒ±
        function formatNumberLocale(number) {
            return new Intl.NumberFormat('en-US').format(number);
        }
        
        async function loadStats() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const content = document.getElementById('content');
            const errorMessage = document.getElementById('error-message');
            
            loading.style.display = 'flex';
            error.style.display = 'none';
            content.style.display = 'none';
            
            try {
                const apiBaseUrl = getApiUrl();
                console.log('API Base URL:', apiBaseUrl);
                console.log('Current domain:', window.location.hostname);
                console.log('Current protocol:', window.location.protocol);
                
                // √ñnce ana endpoint'i test et
                const testResponse = await fetch(`${apiBaseUrl}/`);
                console.log('Ana endpoint test:', testResponse.status, testResponse.statusText);
                
                // Health check endpoint'ini dene
                try {
                    const healthResponse = await fetch(`${apiBaseUrl}/health`);
                    console.log('Health check:', healthResponse.status, healthResponse.statusText);
                    if (healthResponse.ok) {
                        const healthData = await healthResponse.json();
                        console.log('Health data:', healthData);
                    }
                } catch (healthError) {
                    console.log('Health check hatasƒ±:', healthError);
                }
                
                // API test endpoint'ini dene
                try {
                    const apiTestResponse = await fetch(`${apiBaseUrl}/api/stats/test`);
                    console.log('API test endpoint:', apiTestResponse.status, apiTestResponse.statusText);
                } catch (apiTestError) {
                    console.log('API test endpoint hatasƒ±:', apiTestError);
                }
                
                // Sonra stats endpoint'ini test et
                console.log('Stats endpoint isteƒüi:', `${apiBaseUrl}/api/stats`);
                const response = await fetch(`${apiBaseUrl}/api/stats`);
                if (!response.ok) {
                    throw new Error(`ƒ∞statistikler y√ºklenemedi: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                
                // Ana istatistikleri g√ºncelle - locale baƒüƒ±msƒ±z
                document.getElementById('total-videos').textContent = formatNumberLocale(data.totalVideos || 0);
                document.getElementById('total-downloads').textContent = formatNumberLocale(data.totalDownloads || 0);
                document.getElementById('unique-ips').textContent = formatNumberLocale(data.uniqueIPs || 0);
                document.getElementById('unique-names').textContent = formatNumberLocale((data.topNames || []).length);
                
                // En pop√ºler isimler
                const topNamesContainer = document.getElementById('top-names');
                if (data.topNames && data.topNames.length > 0) {
                    topNamesContainer.innerHTML = data.topNames.slice(0, 10).map((item, index) => `
                        <div class="name-item">
                            <div class="name-info">
                                <div class="name-rank ${index < 3 ? 'top3' : 'other'}">${index + 1}</div>
                                <span class="activity-name">${item.name || 'Bilinmeyen'}</span>
                            </div>
                            <div class="name-count">${formatNumberLocale(item.count || 0)} kez</div>
                        </div>
                    `).join('');
                } else {
                    topNamesContainer.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Hen√ºz veri yok</div>';
                }
                
                // Son aktiviteler
                const activityContainer = document.getElementById('recent-activity');
                if (data.recentActivity && data.recentActivity.length > 0) {
                    activityContainer.innerHTML = data.recentActivity.slice(0, 10).map(activity => `
                        <div class="activity-item">
                            <div class="activity-header">
                                <span class="activity-name">${activity.name || 'Bilinmeyen'}</span>
                                <span class="activity-time">${formatDateLocale(activity.timestamp || new Date().toISOString())}</span>
                            </div>
                            <div class="activity-details">${formatIP(activity.ip)} ‚Ä¢ ${activity.action || 'Bilinmeyen'}</div>
                        </div>
                    `).join('');
                } else {
                    activityContainer.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Hen√ºz aktivite yok</div>';
                }
                
                // Saatlik istatistikler
                const hourlyContainer = document.getElementById('hourly-stats');
                if (data.hourlyStats && data.hourlyStats.length > 0) {
                    const maxHourly = Math.max(...data.hourlyStats.map(h => h.count || 0));
                    hourlyContainer.innerHTML = data.hourlyStats.slice(-12).map(hour => `
                        <div class="chart-bar">
                            <span class="chart-label">${hour.hour || 0}:00</span>
                            <div class="chart-visual">
                                <div class="chart-bar-bg">
                                    <div class="chart-bar-fill hourly" style="width: ${maxHourly > 0 ? (hour.count / maxHourly) * 100 : 0}%"></div>
                                </div>
                                <span class="chart-count">${formatNumberLocale(hour.count || 0)}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    hourlyContainer.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Hen√ºz veri yok</div>';
                }
                
                // G√ºnl√ºk istatistikler
                const dailyContainer = document.getElementById('daily-stats');
                if (data.dailyStats.length > 0) {
                    const maxDaily = Math.max(...data.dailyStats.map(d => d.count));
                    dailyContainer.innerHTML = data.dailyStats.slice(-7).map(day => `
                        <div class="chart-bar">
                            <span class="chart-label">${day.date}</span>
                            <div class="chart-visual">
                                <div class="chart-bar-bg">
                                    <div class="chart-bar-fill daily" style="width: ${(day.count / maxDaily) * 100}%"></div>
                                </div>
                                <span class="chart-count">${formatNumberLocale(day.count)}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    dailyContainer.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Hen√ºz veri yok</div>';
                }
                
                // Son g√ºncelleme - locale baƒüƒ±msƒ±z
                document.getElementById('last-update').textContent = formatDateLocale(new Date().toISOString());
                
                loading.style.display = 'none';
                content.style.display = 'block';
                
            } catch (err) {
                console.error('Stats y√ºkleme hatasƒ±:', err);
                loading.style.display = 'none';
                error.style.display = 'block';
                
                // Daha detaylƒ± hata mesajƒ± ve fallback
                if (err.message.includes('404')) {
                    errorMessage.textContent = 'API endpoint bulunamadƒ±. Sunucu √ßalƒ±≈üƒ±yor mu kontrol edin.';
                    console.log('API √ßalƒ±≈ümƒ±yor, varsayƒ±lan veriler g√∂steriliyor...');
                    
                    // Fallback: Varsayƒ±lan veriler g√∂ster
                    showFallbackData();
                } else if (err.message.includes('CORS')) {
                    errorMessage.textContent = 'CORS hatasƒ±. Sunucu ayarlarƒ±nƒ± kontrol edin.';
                } else {
                    errorMessage.textContent = `Hata: ${err.message}`;
                }
            }
        }
        
        // Eski formatDate fonksiyonu kaldƒ±rƒ±ldƒ± - formatDateLocale kullanƒ±lƒ±yor
        
        // Fallback: API √ßalƒ±≈ümadƒ±ƒüƒ±nda varsayƒ±lan veriler g√∂ster
        function showFallbackData() {
            console.log('Fallback veriler g√∂steriliyor...');
            
            // Varsayƒ±lan veriler
            const fallbackData = {
                totalVideos: 0,
                totalDownloads: 0,
                uniqueIPs: 0,
                topNames: [],
                recentActivity: [],
                hourlyStats: [],
                dailyStats: []
            };
            
            // Ana istatistikleri g√ºncelle
            document.getElementById('total-videos').textContent = formatNumberLocale(fallbackData.totalVideos);
            document.getElementById('total-downloads').textContent = formatNumberLocale(fallbackData.totalDownloads);
            document.getElementById('unique-ips').textContent = formatNumberLocale(fallbackData.uniqueIPs);
            document.getElementById('unique-names').textContent = formatNumberLocale(fallbackData.topNames.length);
            
            // Bo≈ü veri mesajlarƒ±
            document.getElementById('top-names').innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">API baƒülantƒ±sƒ± yok - veri yok</div>';
            document.getElementById('recent-activity').innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">API baƒülantƒ±sƒ± yok - veri yok</div>';
            document.getElementById('hourly-stats').innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">API baƒülantƒ±sƒ± yok - veri yok</div>';
            document.getElementById('daily-stats').innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">API baƒülantƒ±sƒ± yok - veri yok</div>';
            
            // Son g√ºncelleme
            document.getElementById('last-update').textContent = formatDateLocale(new Date().toISOString());
            
            // Loading'i gizle, content'i g√∂ster
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            document.getElementById('error').style.display = 'none';
        }
        
        function formatIP(ip) {
            if (!ip || typeof ip !== 'string') {
                return 'Bilinmeyen';
            }
            const parts = ip.split('.');
            if (parts.length === 4) {
                return `${parts[0]}.${parts[1]}.xxx.xxx`;
            }
            return ip;
        }
        
        // Sayfa y√ºklendiƒüinde istatistikleri y√ºkle
        document.addEventListener('DOMContentLoaded', loadStats);
    </script>
</body>
</html>